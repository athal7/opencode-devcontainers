#!/usr/bin/env bash
#
# ocdc-exec - Execute a command in a running devcontainer
#
# Usage:
#   ocdc exec <command> [args...]   # Run command in current workspace's container
#   ocdc exec --workspace <path> <command> [args...]
#
# Examples:
#   ocdc exec bash                  # Open shell in container
#   ocdc exec bin/rails console    # Run rails console
#   ocdc exec npm test             # Run tests
#
# Related commands:
#   ocdc up     - Start devcontainer
#   ocdc down   - Stop devcontainer
#   ocdc list   - List active instances

set -euo pipefail

# Source paths library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/../lib/ocdc-paths.bash"

CACHE_DIR="$OCDC_CACHE_DIR"
PORTS_FILE="$OCDC_PORTS_FILE"
OVERRIDES_DIR="$OCDC_OVERRIDES_DIR"

error() { echo "[ocdc-exec] ERROR: $*" >&2; exit 1; }

# Parse arguments
WORKSPACE=""
CMD_ARGS=()

while [[ $# -gt 0 ]]; do
  case "$1" in
    --workspace|-w)
      WORKSPACE="$2"
      shift 2
      ;;
    --help|-h)
      sed -n '2,/^$/p' "$0" | sed 's/^# //' | sed 's/^#//'
      exit 0
      ;;
    --)
      shift
      CMD_ARGS+=("$@")
      break
      ;;
    *)
      CMD_ARGS+=("$1")
      shift
      ;;
  esac
done

[[ ${#CMD_ARGS[@]} -gt 0 ]] || error "No command specified. Usage: ocdc exec <command> [args...]"

# Determine workspace
if [[ -z "$WORKSPACE" ]]; then
  if git rev-parse --git-dir >/dev/null 2>&1; then
    WORKSPACE=$(git rev-parse --show-toplevel)
  else
    WORKSPACE=$(pwd)
  fi
fi

# Resolve to absolute path with symlinks resolved
WORKSPACE=$(ocdc_resolve_path "$WORKSPACE")

# Check if workspace is tracked
if ! jq -e --arg ws "$WORKSPACE" '.[$ws]' "$PORTS_FILE" >/dev/null 2>&1; then
  error "No devcontainer tracked for: $WORKSPACE\nUse 'ocdc up' to start one."
fi

# Get workspace ID for override file
WORKSPACE_ID=$(ocdc_path_id "$WORKSPACE")
OVERRIDE_FILE="${OVERRIDES_DIR}/${WORKSPACE_ID}.json"

# Build exec args
EXEC_ARGS=("--workspace-folder" "$WORKSPACE")

if [[ -f "$OVERRIDE_FILE" ]]; then
  EXEC_ARGS+=("--override-config" "$OVERRIDE_FILE")
fi

# Execute
exec devcontainer exec "${EXEC_ARGS[@]}" "${CMD_ARGS[@]}"
