#!/usr/bin/env bash
#
# ocdc-list - List devcontainer instances and clones
#
# Usage:
#   ocdc list           # List all tracked instances and orphaned clones
#   ocdc list --json    # Output as JSON
#   ocdc list --active  # Only show instances with running containers
#
# Related commands:
#   ocdc up      - Start devcontainer
#   ocdc down    - Stop devcontainer
#   ocdc go      - Navigate to clone
#   ocdc clean   - Clean up orphaned clones

set -euo pipefail

# Source paths library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/../lib/ocdc-paths.bash"

CACHE_DIR="$OCDC_CACHE_DIR"
PORTS_FILE="$OCDC_PORTS_FILE"
CLONES_DIR="$OCDC_CLONES_DIR"

# Parse arguments
JSON_OUTPUT=false
ACTIVE_ONLY=false

while [[ $# -gt 0 ]]; do
  case "$1" in
    --json|-j)
      JSON_OUTPUT=true
      shift
      ;;
    --active|-a)
      ACTIVE_ONLY=true
      shift
      ;;
    --help|-h)
      sed -n '2,/^$/p' "$0" | sed 's/^# //' | sed 's/^#//'
      exit 0
      ;;
    *)
      echo "Unknown option: $1" >&2
      exit 1
      ;;
  esac
done

# Check if port is actually in use
is_port_active() {
  lsof -i ":$1" >/dev/null 2>&1
}

# Get tracked workspaces
get_tracked_workspaces() {
  if [[ -f "$PORTS_FILE" ]]; then
    jq -r 'keys[]' "$PORTS_FILE" 2>/dev/null || true
  fi
}

# Get current workspace for highlighting (resolve symlinks for consistent comparison)
CURRENT_WS=""
if git rev-parse --git-dir >/dev/null 2>&1; then
  CURRENT_WS=$(ocdc_resolve_path "$(git rev-parse --show-toplevel 2>/dev/null || pwd)")
fi

if [[ "$JSON_OUTPUT" == "true" ]]; then
  # Build combined JSON output
  result="[]"
  
  # Add tracked containers
  if [[ -f "$PORTS_FILE" ]]; then
    tracked=$(jq 'to_entries | map({
      type: "container",
      workspace: .key,
      port: .value.port,
      repo: .value.repo,
      branch: .value.branch,
      started: .value.started
    })' "$PORTS_FILE")
    result=$(echo "$result" "$tracked" | jq -s 'add')
  fi
  
  # Add orphaned clones
  if [[ -d "$CLONES_DIR" ]] && [[ "$ACTIVE_ONLY" != "true" ]]; then
    tracked_ws=$(get_tracked_workspaces)
    for repo_dir in "$CLONES_DIR"/*/; do
      [[ -d "$repo_dir" ]] || continue
      repo_name=$(basename "$repo_dir")
      
      for clone_dir in "$repo_dir"*/; do
        [[ -d "$clone_dir" ]] || continue
        clone_dir="${clone_dir%/}"
        
        if ! echo "$tracked_ws" | grep -qFx "$clone_dir"; then
          branch_name=$(basename "$clone_dir")
          orphan=$(jq -n --arg ws "$clone_dir" --arg repo "$repo_name" --arg branch "$branch_name" '{
            type: "orphan",
            workspace: $ws,
            port: null,
            repo: $repo,
            branch: $branch,
            started: null
          }')
          result=$(echo "$result" "[$orphan]" | jq -s 'add')
        fi
      done
    done
  fi
  
  echo "$result"
else
  # Table output
  has_output=false
  
  # Tracked containers
  if [[ -f "$PORTS_FILE" ]] && [[ $(jq 'length' "$PORTS_FILE") -gt 0 ]]; then
    echo ""
    printf "%-6s  %-20s  %-16s  %-8s  %s\n" "PORT" "REPO" "BRANCH" "STATUS" "WORKSPACE"
    printf "%-6s  %-20s  %-16s  %-8s  %s\n" "──────" "────────────────────" "────────────────" "────────" "─────────"
    
    jq -r 'to_entries[] | "\(.value.port)\t\(.value.repo)\t\(.value.branch)\t\(.key)"' "$PORTS_FILE" | \
    while IFS=$'\t' read -r port repo branch workspace; do
      # Check status
      if is_port_active "$port"; then
        status="\033[32mUP\033[0m    "
      else
        status="\033[31mDOWN\033[0m  "
      fi
      
      # Skip if filtering for active only
      if [[ "$ACTIVE_ONLY" == "true" ]]; then
        is_port_active "$port" || continue
      fi
      
      # Highlight current workspace
      if [[ "$workspace" == "$CURRENT_WS" ]]; then
        marker="* "
      else
        marker="  "
      fi
      
      # Truncate long paths
      if [[ ${#workspace} -gt 40 ]]; then
        display_ws="...${workspace: -37}"
      else
        display_ws="$workspace"
      fi
      
      printf "%-6s  %-20s  %-16s  ${status}  %s%s\n" "$port" "$repo" "$branch" "$marker" "$display_ws"
    done
    has_output=true
  fi
  
  # Orphaned clones (skip if --active)
  if [[ "$ACTIVE_ONLY" != "true" ]] && [[ -d "$CLONES_DIR" ]]; then
    tracked_ws=$(get_tracked_workspaces)
    orphans=""
    
    for repo_dir in "$CLONES_DIR"/*/; do
      [[ -d "$repo_dir" ]] || continue
      repo_name=$(basename "$repo_dir")
      
      for clone_dir in "$repo_dir"*/; do
        [[ -d "$clone_dir" ]] || continue
        clone_dir="${clone_dir%/}"
        
        if ! echo "$tracked_ws" | grep -qFx "$clone_dir"; then
          branch_name=$(basename "$clone_dir")
          orphans="${orphans}${repo_name}\t${branch_name}\t${clone_dir}\n"
        fi
      done
    done
    
    if [[ -n "$orphans" ]]; then
      echo ""
      echo "Orphaned clones (no tracked container):"
      printf "%-6s  %-20s  %-16s  %-8s  %s\n" "PORT" "REPO" "BRANCH" "STATUS" "WORKSPACE"
      printf "%-6s  %-20s  %-16s  %-8s  %s\n" "──────" "────────────────────" "────────────────" "────────" "─────────"
      
      echo -e "$orphans" | while IFS=$'\t' read -r repo branch workspace; do
        [[ -n "$repo" ]] || continue
        
        if [[ ${#workspace} -gt 40 ]]; then
          display_ws="...${workspace: -37}"
        else
          display_ws="$workspace"
        fi
        
        printf "%-6s  %-20s  %-16s  \033[33mORPHAN\033[0m  %s\n" "-" "$repo" "$branch" "$display_ws"
      done
      has_output=true
    fi
  fi
  
  if [[ "$has_output" != "true" ]]; then
    echo "No devcontainer instances or clones found."
    exit 0
  fi
  
  echo ""
  echo "* = current directory"
  echo ""
  echo "Commands:"
  echo "  ocdc go <branch>       Navigate to clone"
  echo "  ocdc exec <cmd>        Execute command in container"
  echo "  ocdc down              Stop current container"
  echo "  ocdc clean             Clean up orphaned clones"
  echo "  ocdc tui               Interactive TUI"
fi
